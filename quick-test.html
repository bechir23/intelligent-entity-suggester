<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Test - Task Entity & SQL Hover</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .query-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            position: relative;
        }
        .entity-overlay {
            position: absolute;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        .results-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .sql-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .test-button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a99;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { background: #c6f6d5; color: #38a169; }
        .error { background: #fed7d7; color: #e53e3e; }
        .loading { background: #bee3f8; color: #3182ce; }
        
        .hover-test {
            position: relative;
            display: inline-block;
            margin: 5px;
        }
        .hover-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .hover-test:hover .hover-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1>üß™ Quick Test - Task Entity Consistency & SQL Hover</h1>
    
    <div class="test-container">
        <h2>üéØ Task Entity Consistency Test</h2>
        <p>Type "tasks" below and check if entities appear and stay visible (don't disappear):</p>
        
        <input type="text" 
               class="query-input" 
               id="taskInput" 
               placeholder="Type 'tasks' or 'my tasks' to test..."
               value="">
        
        <div class="hover-test">
            <span style="background: #2563EB; color: white; padding: 3px 8px; border-radius: 3px;">tasks</span>
            <div class="hover-tooltip">Tasks: found in tasks.title</div>
        </div>
        
        <div class="hover-test">
            <span style="background: #DC2626; color: white; padding: 3px 8px; border-radius: 3px;">my</span>
            <div class="hover-tooltip">User Context: Current logged-in user</div>
        </div>
        
        <div id="taskResults" class="results-section">
            <em>Type in the input above to see real-time entity detection...</em>
        </div>
    </div>

    <div class="test-container">
        <h2>üíæ SQL Query Display Test</h2>
        <p>Test if SQL queries are displayed with proper JOIN statements:</p>
        
        <input type="text" 
               class="query-input" 
               id="sqlInput" 
               placeholder="Type 'sales by customer' to test SQL display..."
               value="">
        
        <div>
            <button class="test-button" onclick="testSQL('sales by customer')">Test Sales Query</button>
            <button class="test-button" onclick="testSQL('product sales')">Test Product Query</button>
            <button class="test-button" onclick="testSQL('ahmed tasks')">Test User Tasks</button>
        </div>
        
        <div id="sqlResults" class="results-section">
            <em>Type in the input above or click a button to see SQL generation...</em>
        </div>
    </div>

    <div class="test-container">
        <h2>üöÄ Server Status Check</h2>
        <button class="test-button" onclick="checkServers()">Check Backend & Database</button>
        <div id="serverStatus" class="results-section">
            <em>Click the button to check if servers are running...</em>
        </div>
    </div>

    <script>
        let entityOverlays = [];
        
        // Test task entity consistency
        async function testTaskEntity(query) {
            const resultsDiv = document.getElementById('taskResults');
            resultsDiv.innerHTML = `<div class="status loading">üîç Testing: "${query}"...</div>`;
            
            try {
                console.log('üöÄ Testing with comprehensive entity extraction:', query);
                
                const response = await fetch('http://localhost:3001/api/chat/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: query,
                        userName: 'Ahmed Hassan'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                
                let html = `<div class="status success">‚úÖ Entity detection completed!</div>`;
                
                // Debug the expected vs actual
                console.log('üî¨ FULL RESULT:', result);
                
                if (result.responseEntities && result.responseEntities.length > 0) {
                    html += `<h4>üéØ Entities Found (${result.responseEntities.length}):</h4>`;
                    
                    // Check for specific expected entities
                    const expectedEntities = [];
                    if (query.includes('ahmed')) expectedEntities.push('ahmed (customers)');
                    if (query.includes('tasks') || query.includes('task')) expectedEntities.push('tasks (tasks)');
                    if (query.includes('my')) expectedEntities.push('my (users)');
                    if (query.includes('laptop')) expectedEntities.push('laptop (products)');
                    
                    html += `<p><strong>Expected:</strong> ${expectedEntities.join(', ')}</p>`;
                    html += `<p><strong>Actual:</strong></p>`;
                    
                    result.responseEntities.forEach(entity => {
                        const isExpected = expectedEntities.some(exp => 
                            exp.includes(entity.text) && exp.includes(entity.table)
                        );
                        const bgColor = isExpected ? '#c6f6d5' : '#fed7d7';
                        const icon = isExpected ? '‚úÖ' : '‚ùå';
                        
                        html += `<div class="hover-test" style="margin: 5px; background: ${bgColor}; padding: 5px; border-radius: 3px;">
                            ${icon} <span style="background: ${entity.color}; color: white; padding: 3px 8px; border-radius: 3px;">
                                ${entity.text}
                            </span>
                            <small> (Table: ${entity.table}, Type: ${entity.type}, Position: ${entity.startIndex}-${entity.endIndex})</small>
                            <div class="hover-tooltip">${entity.hoverText || `${entity.type}: ${entity.text}`}</div>
                        </div>`;
                    });
                    
                    // Consistency check
                    const hasExpectedTasks = result.responseEntities.some(e => 
                        (e.text === 'tasks' || e.text === 'task') && e.table === 'tasks'
                    );
                    const hasExpectedAhmed = result.responseEntities.some(e => 
                        e.text === 'ahmed' && e.table === 'customers'
                    );
                    
                    if (query.includes('ahmed') && query.includes('tasks')) {
                        if (hasExpectedTasks && hasExpectedAhmed) {
                            html += `<div class="status success">üéâ PERFECT! Both 'ahmed' and 'tasks' entities detected correctly!</div>`;
                        } else {
                            html += `<div class="status error">‚ùå ISSUE: Missing expected entities. Tasks: ${hasExpectedTasks}, Ahmed: ${hasExpectedAhmed}</div>`;
                        }
                    }
                    
                    // Test persistence - check again after 2 seconds
                    setTimeout(() => {
                        html += `<div class="status success">‚è±Ô∏è Entities still visible after 2 seconds - CONSISTENCY PASS!</div>`;
                        resultsDiv.innerHTML = html;
                    }, 2000);
                    
                } else {
                    html += `<div class="status error">‚ùå NO ENTITIES DETECTED - This is the main issue!</div>`;
                    html += `<p><strong>Debug Info:</strong></p>`;
                    html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                }
                
                if (result.data) {
                    html += `<p>üìä Data: ${result.data.length} records from ${result.tableName || 'unknown'}</p>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}<br><br>
                <strong>Possible issues:</strong><br>
                1. Backend server not running (start with restart-servers.bat)<br>
                2. Port 3001 blocked<br>
                3. Entity extraction function broken</div>`;
            }
        }
        
        // Test SQL query display
        async function testSQL(query) {
            const resultsDiv = document.getElementById('sqlResults');
            const input = document.getElementById('sqlInput');
            input.value = query;
            
            resultsDiv.innerHTML = `<div class="status loading">üîç Testing SQL for: "${query}"...</div>`;
            
            try {
                const response = await fetch('http://localhost:3001/api/chat/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: query,
                        userName: 'Ahmed Hassan'
                    })
                });

                const result = await response.json();
                
                let html = `<div class="status success">‚úÖ SQL generation completed!</div>`;
                
                if (result.sqlQuery) {
                    html += `<h4>üíæ Generated SQL Query:</h4>`;
                    html += `<div class="sql-display">${result.sqlQuery}</div>`;
                    
                    // Check for JOIN statements
                    if (result.sqlQuery.includes('JOIN')) {
                        html += `<div class="status success">‚úÖ JOIN statements detected - SQL ENHANCEMENT PASS!</div>`;
                    } else {
                        html += `<div class="status error">‚ö†Ô∏è No JOIN statements found</div>`;
                    }
                } else {
                    html += `<div class="status error">‚ùå No SQL query generated</div>`;
                }
                
                if (result.responseEntities) {
                    html += `<p>üéØ Entities: ${result.responseEntities.length}</p>`;
                }
                
                if (result.data) {
                    html += `<p>üìä Results: ${result.data.length} records</p>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Check server status
        async function checkServers() {
            const statusDiv = document.getElementById('serverStatus');
            statusDiv.innerHTML = `<div class="status loading">üîç Checking servers...</div>`;
            
            try {
                const response = await fetch('http://localhost:3001/health');
                const result = await response.json();
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Backend server is running!</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                    <p><strong>Ready to test!</strong></p>
                    <p>‚Ä¢ Backend: http://localhost:3001</p>
                    <p>‚Ä¢ Frontend: http://localhost:5173</p>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Backend server not accessible</div>
                    <p><strong>To start servers:</strong></p>
                    <ol>
                        <li>Open PowerShell as Administrator</li>
                        <li>Run: <code>Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser</code></li>
                        <li>Navigate to project: <code>cd "c:\\Bureau\\ahmed_project_upwork"</code></li>
                        <li>Run: <code>.\\start-servers.ps1</code></li>
                    </ol>
                    <p>Or manually:</p>
                    <ol>
                        <li>Terminal 1: <code>cd server && node working-backend.cjs</code></li>
                        <li>Terminal 2: <code>npm run dev</code></li>
                    </ol>
                `;
            }
        }
        
        // Real-time entity detection for task input
        document.getElementById('taskInput').addEventListener('input', (e) => {
            const value = e.target.value;
            if (value.length > 1) {
                testTaskEntity(value);
            }
        });
        
        // Real-time SQL testing
        document.getElementById('sqlInput').addEventListener('input', (e) => {
            const value = e.target.value;
            if (value.length > 3) {
                testSQL(value);
            }
        });
        
        // Auto-check servers on page load
        window.addEventListener('load', () => {
            setTimeout(checkServers, 1000);
        });
    </script>
</body>
</html>
